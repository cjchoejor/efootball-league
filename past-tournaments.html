<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Tournaments - eFootball League</title>
    <link rel="stylesheet" href="src/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-futbol"></i>
                eFootball League
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="tournament.html" class="nav-link">Tournaments</a>
                <a href="past-tournaments.html" class="nav-link active">Past Tournaments</a>
                <a href="players.html" class="nav-link">Players</a>
                <a href="leaderboard.html" class="nav-link">Leaderboard</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <h2 class="section-title">Past Tournaments</h2>
        <div class="tournaments-grid" id="pastTournamentsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading tournaments...</p>
            </div>
        </div>

        <!-- Tournament Detail Modal -->
        <div id="tournamentDetailModal" class="modal" style="display: none;">
            <div class="modal-content" style="width: 90%; max-width: 900px;">
                <span class="close">&times;</span>
                <h2 id="modalTournamentName"></h2>
                <div id="modalLeaderboard"></div>
            </div>
        </div>
    </main>

    <script src="src/js/utils.js"></script>
    <script>
        let pastTournamentsInstance;

        class PastTournaments {
            constructor() {
                this.baseUrl = '/.netlify/functions';
                this.init();
            }

            async init() {
                this.setupModal();
                await this.loadPastTournaments();
            }

            setupModal() {
                const modal = document.getElementById('tournamentDetailModal');
                const closeBtn = modal.querySelector('.close');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                }

                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            async loadPastTournaments() {
                try {
                    const response = await fetch(`${this.baseUrl}/get-tournaments?status=finished`);
                    let tournaments = await response.json();
                    
                    // Handle wrapped response if needed
                    if (tournaments && tournaments.body && typeof tournaments.body === 'string') {
                        tournaments = JSON.parse(tournaments.body);
                    }
                    
                    this.renderTournaments(tournaments);
                } catch (error) {
                    console.error('Error loading past tournaments:', error);
                    document.getElementById('pastTournamentsGrid').innerHTML = 
                        '<p class="error">Error loading tournaments</p>';
                }
            }

            renderTournaments(tournaments) {
                const container = document.getElementById('pastTournamentsGrid');
                
                if (!tournaments || tournaments.length === 0) {
                    container.innerHTML = '<p class="no-data">No past tournaments found</p>';
                    return;
                }

                container.innerHTML = tournaments.map(tournament => `
                    <div class="tournament-card" onclick="pastTournamentsInstance.viewTournamentLeaderboard('${tournament.id}', '${tournament.name}')">
                        <h3>${tournament.name}</h3>
                        <div class="tournament-meta">
                            <span><i class="fas fa-users"></i> ${tournament.player_count} players</span>
                            <span><i class="fas fa-calendar"></i> ${new Date(tournament.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="tournament-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 100%"></div>
                            </div>
                            <span>${tournament.completed_matches}/${tournament.total_matches} matches - COMPLETED</span>
                        </div>
                    </div>
                `).join('');
            }

            async viewTournamentLeaderboard(tournamentId, tournamentName) {
                try {
                    const response = await fetch(`${this.baseUrl}/get-stats?type=tournament&tournament_id=${tournamentId}`);
                    let stats = await response.json();
                    
                    // Handle wrapped response if needed
                    if (stats && stats.body && typeof stats.body === 'string') {
                        stats = JSON.parse(stats.body);
                    }
                    
                    if (!Array.isArray(stats)) {
                        stats = stats && typeof stats === 'object' ? [stats] : [];
                    }
                    
                    // Display modal with leaderboard
                    const modal = document.getElementById('tournamentDetailModal');
                    const titleEl = document.getElementById('modalTournamentName');
                    const leaderboardEl = document.getElementById('modalLeaderboard');
                    
                    titleEl.textContent = tournamentName + ' - Final Leaderboard';
                    
                    if (!stats || stats.length === 0) {
                        leaderboardEl.innerHTML = '<p>No leaderboard data available</p>';
                    } else {
                        leaderboardEl.innerHTML = this.renderLeaderboard(stats);
                    }
                    
                    modal.style.display = 'block';
                } catch (error) {
                    console.error('Error loading tournament leaderboard:', error);
                    Utils.showNotification('Error loading tournament details', 'error');
                }
            }

            renderLeaderboard(stats) {
                const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#98D8C8"];
                
                const tableHtml = `
                    <div class="leaderboard-table">
                        <div class="table-header">
                            <div class="table-row">
                                <div>Rank</div>
                                <div>Player</div>
                                <div>P</div>
                                <div>W</div>
                                <div>D</div>
                                <div>L</div>
                                <div>GF</div>
                                <div>GA</div>
                                <div>Pts</div>
                            </div>
                        </div>
                        <div class="table-body">
                            ${stats.map((player, idx) => {
                                const teamColor = colors[idx % colors.length];
                                return `
                                    <div class="table-row">
                                        <div style="text-align: center; font-weight: bold;">${idx + 1}</div>
                                        <div class="player-info">
                                            <img src="${player.photo_url || 'src/images/default-avatar.jpg'}" 
                                                 alt="${player.name}" class="player-avatar">
                                            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                                <span style="font-weight: 500;">${player.name}</span>
                                                <span style="font-size: 0.85rem; color: var(--text-secondary); background: ${teamColor}20; padding: 0.25rem 0.5rem; border-radius: 4px; border-left: 3px solid ${teamColor};">${player.team_name}</span>
                                            </div>
                                        </div>
                                        <div>${player.games_played}</div>
                                        <div>${player.wins}</div>
                                        <div>${player.draws}</div>
                                        <div>${player.losses}</div>
                                        <div>${player.goals_scored}</div>
                                        <div>${player.goals_conceded}</div>
                                        <div class="points">${player.points}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                return tableHtml;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            pastTournamentsInstance = new PastTournaments();
        });
    </script>
</body>
</html>